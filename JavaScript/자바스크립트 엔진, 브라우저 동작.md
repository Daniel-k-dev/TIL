# 자바스크립트 엔진, 브라우저와 Nodejs 구조

자바스크립트 엔진은 단 하나의 콜스택(실행 컨텍스트 스택)과 힙을 가집니다.
브라우저와 Nodejs는 자바스크립트 엔진과 이벤트 루프, 태스크 큐 등을 가집니다.

## 전체 구조

![Alt text](<브라우저, nodejs 환경/index.drawio.svg>)

## 자바스크립트 엔진의 내부 구조

자바스크립트 엔진은 콜스택(실행 컨텍스트 스택) + 힙으로 이루어져 있습니다.

![Alt text](<브라우저, nodejs 환경/js-engine.drawio.svg>)

### 힙

힙은 객체가 저장되는 메모리 장소입니다. 콜스택의 원소인 실행 컨텍스트는 힙에 저장된 객체를 참조합니다.

### 콜 스택(실행 컨텍스트 스택)

- [실행 컨텍스트 스택](<실행 컨텍스트.md#실행 컨텍스트 스택>)

## 이벤트 루프

이벤트 루프는 자바스크립트에 동시성을 제공합니다. 이벤트 루프는 Nodejs, 브라우저에 내장된 기능 중 하나입니다.

### 이벤트 루프의 역할

- 콜스택에 현재 실행 중인 실행 컨텍스트가 있는지 확인
- 태스크 큐에 대기 중인 함수가 있는지 반복적인 확인
- 콜스택이 비어있고 대기 중인 함수가 있다면 순차적으로 태스크 큐에 대기 중인 함수를 콜스택으로 이동

### 태스크 큐

태스크 큐는 비동기 함수의 콜백 함수, 이벤트 핸들러가 일시적으로 보관되는 영역입니다.

## Nodejs, 브라우저에서 비동기 함수 실행

- 자바스크립트 엔진에 태스크가 요청되면 콜스택을 통해 요청된 작업 수행
- 비동기 함수에서 소스코드의 평가/실행 이외의 호출 스케쥴링, 콜백 함수의 등록 등 모든 처리는 Nodejs, 브라우저가 처리

## 요약

- 콜스택이 비어있으면 태스크 큐의 요소가 콜스택으로 이동, 실행
- 자바스크립트는 싱글 스래드로 동작, Nodejs, 브라우저는 멀티스래드로 동작
- Nodejs는 libuv, 브라우저는 WebApi에서 비동기 함수의 처리를 실행
- Nodejs, 브라우저는 콜백 함수를 태스크 큐에 등록, 이 콜백은 콜스택이 비워지면 비동기 함수처리의 평가와 실행을 제외한 모든 처리를 하고, 이벤트 루프는 태스크 큐의 원소를 콜스택으로 이동, 자바스크립트 엔진이 이를 실행

<!-- ## 비동기 함수의 실행 순서

1. 자바스크립트 엔진이 비동기 함수 코드를 평가
2. 자바스크립트 엔진이 비동기 함수 코드를 실행
3. 비동기 함수의 실행 컨텍스트가 콜스택에서 제거, Nodejs/브라우저는 비동기 함수의 코드를 실행 그 때 자바스크립트 엔진은 다른 함수를 평가/실행
4. 브라우저의 비동기 함수 실행 끝, 브라우저가 콜백함수를 태스크 큐에 등록
5. 콜스택 비워짐
6. 이벤트 루프가 콜스택이 비워짐을 감지하고 태스크 큐의 원소를 콜스택으로 이동
7. 자바스크립트 엔진은 콜스택의 요소 실행
8. 콜스택 비워짐
9. 종료 -->

> 참고 : [어쨌든 이벤트 루프는 무엇입니까? | Philip Roberts | JSConf EU](https://www.youtube.com/watch?v=8aGhZQkoFbQ)