# 실행 컨텍스트 <!-- omit in toc -->

실행 컨텍스트는 소스코드를 실행하기 위한 환경을 제공하고 코드의 실행 결과를 관리합니다.

실행 컨텍스트는 식별자를 등록하고 관리하는 스코프(렉시컬 환경)와 코드 실행 순서를 관리를 구현한 내부 메커니즘(실행 컨텍스트 스택)입니다.

모든 소스코드는 실행 컨텍스트를 통해 실행, 관리됩니다.

- [소스코드 타입](#소스코드-타입)
- [소스코드 평가, 실행 (런타임)](#소스코드-평가-실행-런타임)
  - [평가](#평가)
  - [실행](#실행)
- [실행 컨텍스트 스택](#실행-컨텍스트-스택)
- [렉시컬 환경](#렉시컬-환경)
  - [렉시컬 환경 구성요소](#렉시컬-환경-구성요소)
- [코드의 평가, 실행 과정](#코드의-평가-실행-과정)
  - [전역 코드 평가 과정(순서)](#전역-코드-평가-과정순서)
    - [전역 환경 레코드](#전역-환경-레코드)
    - [객체 환경 레코드 생성](#객체-환경-레코드-생성)
    - [this 바인딩](#this-바인딩)
    - [전역 실행 컨텍스트 그림 요약](#전역-실행-컨텍스트-그림-요약)
  - [식별자 결정](#식별자-결정)
  - [함수 코드 평가](#함수-코드-평가)
  - [함수 코드 실행](#함수-코드-실행)
    - [함수 실행 컨텍스트 그림 요약](#함수-실행-컨텍스트-그림-요약)
  - [블록 레벨 스코프와 실행 컨텍스트](#블록-레벨-스코프와-실행-컨텍스트)
    - [블록 레벨 스코프와 실행 컨텍스트 그림 요약](#블록-레벨-스코프와-실행-컨텍스트-그림-요약)


## 소스코드 타입

| 소스코드 타입 |                             하는 일                              |      컨텍스트      |
| :-----------: | :--------------------------------------------------------------: | :----------------: |
|   전역 코드    |  전역 스코프 생성, (전역 변수, 전역 함수, 전역 객체) 연결, 관리  | 전역 실행 컨텍스트 |
|   함수 코드    | 지역 스코프 생성, (지역변수, 매개변수, arguments 객체) 연결, 관리 | 함수 실행 컨텍스트 |
|     eval      |                   자신만의 독자적 스코프 생성                    | eval 실행 컨텍스트 |
|  모듈 스코프  |               모듈별로 독립적인 모듈 스코프를 생성               | 모듈 실행 컨텍스트 |

## 소스코드 평가, 실행 (런타임)

자바스크립트 엔진은 모든 소스코드에 대해 **평가**와 **실행**으로 나누어 처리합니다.

실행은 **런타임**을 의미합니다.

### 평가

1. 실행 컨텍스트 생성
2. 선언문만 실행
3. 생성된 변수, 함수 식별자를 실행 컨텍스트가 관리하는 스코프에 등록

### 실행

1. 변수나 함수의 참조를 실행, 컨텍스트가 관리하는 스코프에서 검색, 취득한다.
2. 실행 결과를 실행 컨텍스트가 관리하는 스코프에 반영

## 실행 컨텍스트 스택

실행 컨텍스트 스택은 코드의 실행 순서를 관리합니다.

코드가 평가되면 실행 컨텍스트가 생성되고 스택의 맨 위에 쌓입니다. 실행 컨텍스트 스택의 맨 위는 실행 중인 실행 컨텍스트입니다.

## 렉시컬 환경

렉시컬 환경은 식별자와 식별자에 바인딩 된 값, 상위 스코프에 대한 참조를 가집니다.

렉시컬 환경은 키와 값을 가지는 객체 형태의 자료구조이고 스코프와 식별자를 관리하는 렉시컬 스코프의 실체입니다.

### 렉시컬 환경 구성요소

|         레코드 종류          |              하는 일               |
| :--------------------------: | :--------------------------------: |
|         환경 레코드          | 스코프에 포함된 식별자와 값을 관리 |
| 외부 렉시컬 환경에 대한 참조 |      상위 스코프를 가리킨다.       |

`외부 렉시컬 환경에 대한 참조`에서 상위 스코프를 가리키기 때문에 단방향 링크드 리스트인 스코프 체인을 이루게 됩니다.

## 코드의 평가, 실행 과정

### 전역 코드 평가 과정(순서)

> 전역 객체는 전역 코드가 평가되기 이전에 생성된다.

1. 전역 실행 컨텍스트 생성
2. 전역 렉시컬 환경 생성
   1. [전역 환경 레코드 생성](#전역-환경-레코드)
      1. [객체 환경 레코드 생성](#객체-환경-레코드-생성)
      2. 선언적 환경 레코드 생성
   2. [this](#this-바인딩)
   3. 외부 렉시컬 환경에 대한 참조 설정

#### 전역 환경 레코드

|       레코드       |                        관리 대상                        |
| :----------------: | :----------------------------------------------------: |
|   객체 환경 레코드   | var 선언문, 함수 선언문, 빌트인 객체, 표준 빌트인 객체 |
| 선언적 환경 레코드 |                 (let, const) 변수               |

#### 객체 환경 레코드 생성

객체 환경 레코드의 BindingObject속성은 전역 객체를 가리킵니다.

BindingObject는 전역 객체(window...) 생성 시 같이 생성되고 var 선언문, 함수선언문은 `실행 컨텍스트 -> 렉시컬 환경 -> 객체 환경 레코드의 BindingObject`를 거쳐 전역 객체에 등록됩니다.

#### this 바인딩

- 렉시컬 환경의 `[[GlobalThisValue]]` 내부 슬롯에 this 바인딩
- this 바인딩은 **전역 환경 레코드**와 **함수 환경 레코드**에만 존재

#### 전역 실행 컨텍스트 그림 요약

![Alt text](<실행 컨텍스트/global-excute-context.drawio.svg>)

### 식별자 결정

식별자 결정은 어느 스코프의 식별자를 참조할지 결정하는 것입니다.

식별자 결정을 위해 탐색할 때 실행 중인 컨텍스트부터 검색하고, 없으면 상위 스코프로 이동하면서 탐색합니다.

### 함수 코드 평가

1. 함수 실행 컨텍스트 생성
2. 함수 렉시컬 환경 생성
   1. 함수 환경 레코드 생성
      - 매개변수, arguments, 지역변수를 관리합니다.
   2. this 바인딩
      - 함수 호출 방식에 따라 결정됩니다.
   3. 외부 렉시컬 환경에 대한 참조 결정 => 상위 스코프

### 함수 코드 실행

실행 중인 실행 컨텍스트의 실행 환경에서 식별자를 검색하고 없으면 상위 스코프로 이동하면서 탐색합니다.

#### 함수 실행 컨텍스트 그림 요약

![Alt text](<실행 컨텍스트/function-conetext.drawio.svg>)

### 블록 레벨 스코프와 실행 컨텍스트

1. 새로운 렉시컬 환경 생성
2. 선언적 환경 레코드 설정 (let, const)
3. 기존 실행 컨텍스트는 새로 생성된 렉시컬 환경으로 교체
4. 외부참조는 블록이 실행되기 이전의 렉시컬 환경

코드 블록의 실행이 끝나면 이전의 실행 컨텍스트가 기존의 렉시컬 환경으로 교체합니다.

#### 블록 레벨 스코프와 실행 컨텍스트 그림 요약

![Alt text](<실행 컨텍스트/block-level-scope.drawio.svg>)